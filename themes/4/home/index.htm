<div class="container bg-3">
    bnc_position_home
</div>

<style>
    h3 {
        font-size: 18px;
    }
</style>
<script>
    var routeBackId;
    var isRound;
    $(document).ready(function () {

        $('#depatureDate').val($.format.date(new Date() ,"dd/MM/yyyy"));

        $('html, body').animate({
            scrollTop: $(".bg-3").offset().top
        },1000);

        var isMobile = {
            Android: function() {
                return navigator.userAgent.match(/Android/i);
            },
            BlackBerry: function() {
                return navigator.userAgent.match(/BlackBerry/i);
            },
            iOS: function() {
                return navigator.userAgent.match(/iPhone|iPad|iPod/i);
            },
            Opera: function() {
                return navigator.userAgent.match(/Opera Mini/i);
            },
            Windows: function() {
                return navigator.userAgent.match(/IEMobile/i);
            },
            any: function() {
                return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows());
            }
        };

        var companyId = '$_anvuiId';
        var urlAndroid = '';
        var urlIOs = '';
        if(companyId == 'TC03h1IzK1jParS')
        {
            urlAndroid = 'https://play.google.com/store/apps/details?id=vn.anvui.phucxuyen';
            urlIOs = 'https://itunes.apple.com/app/id1364355888';
        }

        if(isMobile.any() != null) {
            if(isMobile.any()[0] == 'Android' && urlAndroid != '')
            {
                window.location.href = urlAndroid;
            }

            if((isMobile.any()[0] == 'iPhone' || isMobile.any()[0] == 'iPad' || isMobile.any()[0] == 'iPod') && urlIOs != '')
            {
                window.location.href = urlIOs;
            }
        }



        //Lấy ajax thông tin chuyến
        $.ajax({
            type: "POST",
            url: "https://anvui.vn/chuyenAV",
            data: {
                idAV: companyId
            },
            success: function (result) {
                if(result.chuyen.length < 1) {
                    alert('Nhà xe hiện chưa có tuyến');
                    return;
                }
                $.each(result.chuyen, function (key, item) {
                    $('#routeId').append('<option value="' + item.routeId + '" data-routeback="' + item.routeBack + '">' + item.routeName + '</option>');
                });

                //Lấy thông tin điểm đầu cuối tren url, neu khong co thi lay chuyen dau tien

                $('#routeId').val(result.chuyen[0].routeId).change();
            }
        });

        //Sự kiện thay đổi route
        $('#routeId').change(function () {
            routeBackId = $(this).find(':selected').data('routeback');
            $('#routeName').val($(this).find(':selected').text());
            getPoint($(this).val());
        });

        $('#depatureDate').datepicker({
            dateFormat: 'dd/mm/yy',
            defaultDate: "+0d",
            minDate: 0,
            onSelect: function (dateStr) {
                startPoint = $('#startPoint').val();
                endPoint = $('#endPoint').val();
                routeId = $('#routeId').val();
                changeDate(dateStr);
            }
        });

        $('#returnDate').datepicker({
            dateFormat: 'dd/mm/yy',
            defaultDate: "+0d",
            minDate: 0,
        });

        //Tìm chuyến
        $('#search-btn').click(function () {
            depatureDate = $('#depatureDate').val();
            returnDate = $('#returnDate').val();
            routeId = $('#routeId').val();
            startPoint = $('#startPoint').val();
            endPoint = $('#endPoint').val();



            var routeName = $('#routeId').find('option:selected').text();

            $('.start').html(routeName.split("-")[0]);
            $('.end').html(routeName.split("-")[1]);
            $('.startDate').html($('#depatureDate').val());
            $('.startDateReturn').html($('#returnDate').val());
            $('.routeName').html(routeName);
            $('.routeNameReturn').html(routeName.split("-")[1] + " - " + routeName.split("-")[0]);

            if(isRound == 1) {
                if(routeBackId === 'undefined') {
                    $('#oneway').click();
                    $.alert({
                        title: 'Cảnh báo!',
                        type: 'red',
                        typeAnimated: true,
                        content: 'Chuyến không có khứ hồi',
                    });
                    return false;
                }
                $('#routeBackId').val(routeBackId);
            } else {
                $('#routeBackId').val('');
            }


            if (routeId === "") {
                $.alert({
                    title: 'Cảnh báo!',
                    type: 'red',
                    typeAnimated: true,
                    content: 'Chưa chọn tuyến đường',
                });
                return false;
            }

            if (startPoint === "") {
                $.alert({
                    title: 'Cảnh báo!',
                    type: 'red',
                    typeAnimated: true,
                    content: 'Chưa chọn điểm đi',
                });
                return false;
            }

            if (endPoint === "") {
                $.alert({
                    title: 'Cảnh báo!',
                    type: 'red',
                    typeAnimated: true,
                    content: 'Chưa chọn điếm đến',
                });
                return false;
            }

            if (depatureDate === "") {
                $.alert({
                    title: 'Cảnh báo!',
                    type: 'red',
                    typeAnimated: true,
                    content: 'Chưa chọn ngày đi',
                    onClose: function () {
                        $('#depatureDate').datepicker('show');
                    }
                });

                return false;
            }

            //có khứ hồi
            if(isRound == 1) {

                if (returnDate === "") {
                    $.alert({
                        title: 'Cảnh báo!',
                        type: 'red',
                        typeAnimated: true,
                        content: 'Chưa chọn ngày về',
                        onClose: function () {
                            $('#returnDate').datepicker('show');
                        }
                    });
                    return false;
                }

                $('.endDate').html($('#returnDate').val());

                $('#trip-round').show();
                $('#total-round').show();

            }

            $('#trip-oneway').show();
            $('#next-step').show();
            $('#booking-form').hide();

        });

        //chọn khứ hồi
        $('#roundtrip').click(function () {
            isRound = 1;
            $('.selectday').removeClass('selected');
            $(this).addClass('selected');
            $('#returnDate').prop('disabled', false);
            changeDate($('#depatureDate').val());
        });

        //chọn một chiều
        $('#oneway').click(function () {
            isRound = 0;
            $('.selectday').removeClass('selected');
            $(this).addClass('selected');
            $('#returnDate').val('');
            $('#returnDate').prop('disabled', true);
        });
    });

    function changeDate(dateStr) {
        if(dateStr === '') {
            return;
        }
        var date_Str = '';
        for (var i = 0; i < 10; i++) {

            if (i == 1 || i == 0) {
                date_Str += dateStr.charAt(i + 3);
            } else if (i == 3 || i == 4) {
                date_Str += dateStr.charAt(i - 3);
            }
            else date_Str += dateStr.charAt(i);
        }
        if(isRound == 1) {
            $('#returnDate').datepicker("option", {
                minDate: new Date(date_Str)
            });
            $('#returnDate').val(dateStr);
        }
    }

    //Lấy ajax điểm đầu điểm cuối
    function getPoint(routeId) {
        $('#startPoint').html('<option value="">Điểm đi</option>');
        $('#endPoint').html('<option value="">Điểm đến</option>');

        $.ajax({
            type: "POST",
            url: "https://anvui.vn/pointNX",
            data: {
                routeId: routeId
            },
            success: function (result) {

                // routeBackId = result.routeBack;

                //lấy thông tin điểm đầu
                $.each(result.a1, function (key, item) {
                    $('#startPoint').append('<option value="' + item.pointId + '">' + item.pointName + '</option>');
                });
                $('#startPoint').val(result.a1[0].pointId).change();

                //lấy thông tin điểm cuối
                $.each(result.a2, function (key, item) {
                    $('#endPoint').append('<option value="' + item.pointId + '">' + item.pointName + '</option>');
                });
                $('#endPoint').val(result.a2[0].pointId).change();
            }
        });
    }

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

</script>